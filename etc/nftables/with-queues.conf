#!/usr/sbin/nft -f

flush ruleset

table inet filter {
    chain input {
        type filter hook input priority 0; policy drop;
        
        ct state {established, related} accept
        ct state invalid drop
        
        iifname "lo" accept
        iifname "wg0" accept
        
        # SSH access
        tcp dport 22 accept
        
        # WireGuard
        udp dport 51820 accept
    }
    
    chain forward {
        type filter hook forward priority 0; policy drop;
        
        ct state {established, related} accept
        ct state invalid drop
        
        # Allow forwarding from WireGuard to internet
        iifname "wg0" oifname "eno1" accept
        iifname "eno1" oifname "wg0" ct state {established, related} accept
    }
    
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        oifname "eno1" masquerade
    }
}

table inet traffic_shaping {
    # Очереди для разных типов трафика
    chain output {
        type filter hook output priority -300; policy accept;
        
        # YouTube - очередь 200 для TCP, 201 для UDP
        ip daddr { 173.194.0.0/16, 206.111.0.0/16, 74.125.0.0/16, 209.85.128.0/17, 216.58.192.0/19, 172.217.0.0/16, 108.177.0.0/17 } tcp dport { 80, 443 } queue num 200
        ip daddr { 173.194.0.0/16, 206.111.0.0/16, 74.125.0.0/16, 209.85.128.0/17, 216.58.192.0/19, 172.217.0.0/16, 108.177.0.0/17 } udp dport { 80, 443, 19302-19309 } queue num 201
        
        # Instagram - очередь 202 для TCP, 203 для UDP
        ip daddr { 157.240.0.0/17, 157.240.192.0/18, 31.13.64.0/18 } tcp dport { 80, 443 } queue num 202
        ip daddr { 157.240.0.0/17, 157.240.192.0/18, 31.13.64.0/18 } udp dport { 80, 443 } queue num 203
        
        # Discord - очередь 204 для TCP, 205 для UDP
        ip daddr { 162.159.128.0/17, 162.159.192.0/18, 199.96.56.0/21 } tcp dport { 80, 443 } queue num 204
        ip daddr { 162.159.128.0/17, 162.159.192.0/18, 199.96.56.0/21 } udp dport { 80, 443, 3478-3481 } queue num 205
    }
    
    chain forward {
        type filter hook forward priority -300; policy accept;
        
        # Аналогичные правила для форвардинга
        ip daddr { 173.194.0.0/16, 206.111.0.0/16, 74.125.0.0/16, 209.85.128.0/17, 216.58.192.0/19, 172.217.0.0/16, 108.177.0.0/17 } tcp dport { 80, 443 } queue num 200
        ip daddr { 173.194.0.0/16, 206.111.0.0/16, 74.125.0.0/16, 209.85.128.0/17, 216.58.192.0/19, 172.217.0.0/16, 108.177.0.0/17 } udp dport { 80, 443, 19302-19309 } queue num 201
        
        ip daddr { 157.240.0.0/17, 157.240.192.0/18, 31.13.64.0/18 } tcp dport { 80, 443 } queue num 202
        ip daddr { 157.240.0.0/17, 157.240.192.0/18, 31.13.64.0/18 } udp dport { 80, 443 } queue num 203
        
        ip daddr { 162.159.128.0/17, 162.159.192.0/18, 199.96.56.0/21 } tcp dport { 80, 443 } queue num 204
        ip daddr { 162.159.128.0/17, 162.159.192.0/18, 199.96.56.0/21 } udp dport { 80, 443, 3478-3481 } queue num 205
    }
}
